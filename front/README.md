# Frontend приложения

## Описание

Frontend приложения для управления цифровыми фотографиями в мессенджере Max. Построен на React с использованием библиотеки MaxUI для интеграции с мессенджером.

## Технологический стек

- **React 18.3.1** - библиотека для создания пользовательских интерфейсов
- **Vite 7.2.2** - сборщик и dev-сервер
- **@maxhub/max-ui 0.1.12** - UI компоненты для Max
- **html5-qrcode 2.3.8** - сканирование QR-кодов
- **qrcode.react 3.2.0** - генерация QR-кодов
- **Bootstrap 5.3.8** - CSS фреймворк (частично)

## Конфигурация и запуск

### Локальная разработка (без Docker)

1.  **Установка зависимостей:**
    ```bash
    npm install
    ```

2.  **Запуск dev-сервера:**
    ```bash
    npm run dev
    ```
    Приложение будет доступно по адресу, указанному в `VITE_DEV_PORT` в вашем `.env` файле (по умолчанию `http://localhost:5173`).

### Запуск через Docker

Этот метод использует `docker-compose` для сборки и запуска контейнера.

1.  **(Опционально) Создайте файл конфигурации `.env`:**
    Скопируйте `.env.example` в новый файл с именем `.env`. Вы можете изменить `VITE_DEV_PORT` для запуска на другом порту или `VITE_API_URL` для использования другого бэкенда.
    ```bash
    cp .env.example .env
    ```
    Если вы не создадите `.env` файл, приложение будет использовать значения по умолчанию (API `https://api.whitea.cloud` через прокси и порт `5444`).

2.  **Сборка и запуск контейнера:**
    ```bash
    docker-compose up -d --build
    ```
    Приложение будет доступно по адресу, указанному в `VITE_DEV_PORT` (например, `http://localhost:5444`).

### Запуск готового образа из Docker Hub

Этот способ использует уже опубликованный образ.

1.  **Загрузите образ:**
    ```bash
    docker pull oligovit6/max-photo-gallery-frontend:latest
    ```

2.  **Запустите контейнер:**
    - **С портом по умолчанию (5444):**
      ```bash
      docker run -d -p 5444:5444 --name max-photo-gallery-frontend oligovit6/max-photo-gallery-frontend:latest
      ```
    - **С другим портом (например, 8080):**
      Используйте флаг `-e` для передачи переменной окружения `VITE_DEV_PORT`.
      ```bash
      docker run -d -p 8080:8080 -e VITE_DEV_PORT=8080 --name max-photo-gallery-frontend oligovit6/max-photo-gallery-frontend:latest
      ```

## Структура проекта

```
front/
├── src/
│   ├── App.jsx                    # Главный компонент приложения
│   ├── App.css                    # Стили приложения
│   ├── main.jsx                   # Точка входа
│   ├── api/
│   │   └── apiClient.js          # API клиент для работы с backend
│   ├── screens/                  # Экраны приложения
│   │   ├── WelcomeScreen.jsx     # Экран приветствия
│   │   ├── CollectionScreen.jsx  # Экран коллекции фотографий
│   │   ├── ViewingScreen.jsx     # Просмотр фотографии
│   │   ├── ApprovalScreen.jsx   # Подтверждение трейдов
│   │   ├── PhotoSelectionScreen.jsx  # Выбор фотографий
│   │   ├── ProfileViewScreen.jsx # Просмотр профиля
│   │   ├── PermissionsScreen.jsx # Управление разрешениями
│   │   ├── PublicFeedScreen.jsx  # Публичная лента
│   │   └── LoaderScreen.jsx      # Экран загрузки
│   └── utils/                    # Утилиты
│       ├── dateUtils.js          # Работа с датами
│       └── hapticFeedback.js     # Тактильная обратная связь
├── public/                        # Статические файлы
├── index.html                     # HTML шаблон
├── package.json                   # Зависимости
└── vite.config.js                 # Конфигурация Vite
```

## Экраны приложения

### 1. WelcomeScreen
Экран приветствия и авторизации пользователя.

**Функционал:**
- Авторизация через данные мессенджера Max
- Проверка токенов в localStorage
- Перенаправление на главный экран после авторизации

### 2. CollectionScreen
Главный экран с коллекцией фотографий пользователя.

**Функционал:**
- Отображение всех фотографий (собственных и импортированных)
- Группировка по датам
- Загрузка новых фотографий (камера/галерея)
- Сканирование QR-кодов для получения фотографий
- Создание QR-кодов для обмена фотографиями
- Удаление фотографий
- Добавление в избранное
- Просмотр публичных профилей
- Настройки профиля (публичный/приватный)
- Ссылка для связи

**Особенности:**
- Поддержка drag & drop для загрузки (десктоп)
- Долгое нажатие для выбора фотографий (мобильные)
- Тактильная обратная связь при действиях

### 3. ViewingScreen
Экран просмотра отдельной фотографии.

**Функционал:**
- Полноэкранный просмотр фотографии
- Навигация между фотографиями (свайп/стрелки)
- Добавление/удаление из избранного
- Удаление фотографии
- Просмотр метаданных (описание, теги)
- Редактирование метаданных

### 4. ApprovalScreen
Экран подтверждения полученных трейдов.

**Функционал:**
- Просмотр ожидающих подтверждения трейдов
- Подтверждение или отклонение трейдов
- Просмотр превью фотографий

### 5. PhotoSelectionScreen
Экран выбора фотографий для одобрения запроса на просмотр профиля.

**Функционал:**
- Выбор фотографий для показа запрашивающему пользователю
- Подтверждение или отклонение запроса

### 6. ProfileViewScreen
Экран просмотра профиля другого пользователя.

**Функционал:**
- Просмотр информации о пользователе
- Просмотр доступных фотографий
- Импорт фотографий из профиля
- Запрос на просмотр профиля (если приватный)
- Добавление фотографий в избранное

### 7. PermissionsScreen
Экран управления разрешениями доступа к фотографиям.

**Функционал:**
- Просмотр всех запросов на просмотр профиля
- Одобрение/отклонение запросов
- Выбор фотографий для показа при одобрении

### 8. PublicFeedScreen
Экран публичной ленты фотографий.

**Функционал:**
- Просмотр публичных фотографий всех пользователей
- Фильтрация по тегам
- Просмотр профилей авторов
- Добавление в избранное

### 9. LoaderScreen
Экран загрузки при инициализации приложения.

## API Client

Модуль `api/apiClient.js` предоставляет методы для работы с backend API.

### Основные методы:

- `login(initData)` - Авторизация пользователя
- `logout()` - Выход из системы
- `refreshAuth()` - Обновление токена
- `getPhotos()` - Получение фотографий
- `uploadPhotos(files)` - Загрузка фотографий
- `deletePhoto(photoId)` - Удаление фотографии
- `getFavoriteIds()` - Получение ID избранных фотографий
- `addToFavorites(photoId)` - Добавление в избранное
- `removeFromFavorites(photoId)` - Удаление из избранного
- `createShareTrades(photoIds)` - Создание обмена
- `scanShareToken(token)` - Сканирование QR-кода
- `getScannedTrades()` - Получение отсканированных трейдов
- `confirmTrade(tradeId)` - Подтверждение трейда
- `rejectTrade(tradeId)` - Отклонение трейда
- `getProfileSettings()` - Получение настроек профиля
- `togglePublicProfile(value)` - Переключение публичности профиля
- `updateContactLink(link)` - Обновление ссылки для связи

### Автоматическое обновление токенов

API клиент автоматически обновляет access токен при получении 401 ошибки, используя refresh токен.

## WebSocket

Приложение использует WebSocket для получения обновлений в реальном времени:

- Обновления материалов (новые фотографии, трейды)
- Уведомления о запросах на просмотр профиля

Подключение устанавливается автоматически после авторизации.

## Работа с QR-кодами

### Сканирование QR-кодов

Поддерживается два способа:
1. **Системный сканер Max** (через `window.WebApp.openCodeReader()`)
2. **HTML5 QR Scanner** (для веб-версии)

### Генерация QR-кодов

QR-коды генерируются для:
- Обмена фотографиями (`trade:{share_token}`)
- Просмотра профиля (`user:{user_id}`)

## Интеграция с Max

Приложение использует API мессенджера Max:

- `window.WebApp.initDataUnsafe` - Данные пользователя
- `window.WebApp.openCodeReader()` - Открытие сканера QR-кодов
- `window.WebApp.showPopup()` - Показ всплывающих окон
- `window.WebApp.ready()` - Уведомление о готовности приложения
- `window.WebApp.expand()` - Развертывание приложения

## Стилизация

### CSS модули

Каждый экран имеет свой CSS файл:
- `CollectionScreen.css`
- `ViewingScreen.css`
- `PublicFeedScreen.css`
- и т.д.

### Адаптивность

Приложение адаптируется под мобильные и десктоп устройства:
- Разные интерфейсы для мобильных и десктоп
- Оптимизация для touch-устройств
- Поддержка жестов (свайп, долгое нажатие)

## Утилиты

### dateUtils.js
Функции для работы с датами:
- `groupPhotosByDate(photos)` - Группировка фотографий по датам

### hapticFeedback.js
Тактильная обратная связь:
- `triggerHapticNotification(type)` - Уведомления
- `triggerHapticImpact(style)` - Воздействия

## Разработка

### Установка зависимостей

```bash
npm install
```

### Запуск dev-сервера

```bash
npm run dev
```

Приложение будет доступно по адресу `http://localhost:5173`

### Сборка для production

```bash
npm run build
```

Собранные файлы будут в директории `dist/`

### Preview production сборки

```bash
npm run preview
```

### Запуск через Docker

#### 1. С помощью Docker Compose (рекомендуется для разработки)

Этот способ автоматически соберет образ и запустит контейнер.

```bash
docker-compose up -d
```

Приложение будет доступно по адресу `http://localhost:5444`.

#### 2. Из готового образа на Docker Hub

Этот способ использует уже опубликованный образ.

1.  **Загрузите образ:**
    ```bash
    docker pull oligovit6/max-photo-gallery-frontend:latest
    ```

2.  **Запустите контейнер:**
    ```bash
    docker run -d -p 5444:5444 --name max-photo-gallery-frontend oligovit6/max-photo-gallery-frontend:latest
    ```

## Конфигурация Vite

Настройки в `vite.config.js`:
- Порт: 5444
- HMR через WebSocket (wss) для production
- Прокси для публичных профилей

## Особенности реализации

### Управление состоянием

Используется React hooks для управления состоянием:
- `useState` - локальное состояние компонентов
- `useEffect` - побочные эффекты
- `useCallback` - мемоизация функций
- `useRef` - ссылки на DOM элементы

### Оптимизация производительности

- Мемоизация функций через `useCallback`
- Предотвращение повторных рендеров
- Ленивая загрузка изображений
- Группировка запросов к API

### Обработка ошибок

- Try-catch блоки для всех асинхронных операций
- Показ пользователю понятных сообщений об ошибках
- Автоматический retry при ошибках сети

## Безопасность

1. **Токены:** Хранятся в localStorage, автоматически обновляются
2. **Валидация:** Валидация данных перед отправкой на сервер
3. **XSS:** React автоматически экранирует данные
4. **CORS:** Настроен на стороне backend

## Отладка

В режиме разработки автоматически подключается Eruda для отладки на мобильных устройствах:
- Консоль
- Сетевые запросы
- Ресурсы

## Поддержка браузеров

- Chrome/Edge (последние версии)
- Safari (iOS 12+)
- Firefox (последние версии)
- Встроенный браузер Max

## Производительность

### Оптимизации

- Code splitting через Vite
- Минификация в production
- Оптимизация изображений (на стороне backend)
- Ленивая загрузка компонентов

### Метрики

Рекомендуется отслеживать:
- Время загрузки приложения
- Время ответа API
- Размер bundle
- Производительность рендеринга

## Развертывание

### PM2 Process Manager

Рекомендуется использовать PM2 для управления процессом приложения в production:

```bash
# Установка PM2 глобально
npm install -g pm2

# Запуск приложения
pm2 start npm --name "frontend" -- run preview

# Автозапуск при перезагрузке сервера
pm2 startup
pm2 save

# Просмотр логов
pm2 logs frontend

# Перезапуск
pm2 restart frontend

# Остановка
pm2 stop frontend
```

### Nginx конфигурация

Для домена `whitea.cloud` подготовлена конфигурация Nginx (файл `whitea.cloud` в корне проекта).

**Требования:**
- **Wildcard SSL-сертификат** для `*.whitea.cloud` (необходим для поддержки поддоменов)
- Сертификаты должны быть размещены в директории `letsencrypt/`
